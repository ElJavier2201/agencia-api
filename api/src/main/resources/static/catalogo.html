<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo - Titan Autos</title>

    <link rel="stylesheet" href="/css/normalize.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Staatliches&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">

    <style>
        /* --- ESTILOS ADICIONALES (Funcionalidad) --- */
        .filtros-bar {
            background-color: var(--secundarioscuro);
            padding: 2rem;
            margin-bottom: 3rem;
            border-radius: 1rem;
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            border-bottom: 4px solid var(--primario);
        }
        .filtro-grupo label { color: var(--blanco); font-family: var(--fuentePrincipal); font-size: 2rem; margin-right: 1rem; }
        .filtro-grupo input, .filtro-grupo select { padding: 0.8rem; border: none; border-radius: 0.5rem; font-family: 'Nunito', sans-serif; font-size: 1.6rem; }

        .producto { cursor: pointer; transition: transform 0.3s ease; position: relative; }
        .producto:hover { transform: scale(1.03); box-shadow: 0 0 15px rgba(255,255,255,0.1); }

        .etiqueta-estado {
            position: absolute; top: 1rem; right: 1rem;
            background-color: var(--primario); color: var(--blanco);
            padding: 0.5rem 1rem; font-family: var(--fuentePrincipal); font-size: 1.4rem;
            border-radius: 0.5rem; z-index: 10;
        }

        .boton-card {
            display: block; width: 90%; margin: 0 auto 1.5rem auto; padding: 1rem;
            background-color: var(--primario); color: var(--blanco); border: none;
            font-family: var(--fuentePrincipal); font-size: 1.8rem; cursor: pointer;
            text-align: center; border-radius: 0.5rem; transition: background-color 0.3s;
        }
        .boton-card:hover { background-color: var(--primarioocuro); }

        /* Modales */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-contenido { background-color: var(--fondoclaro); padding: 3rem; border-radius: 1rem; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; border: 2px solid var(--primario); color: var(--blanco); position: relative; }
        .modal-close { position: absolute; top: 1rem; right: 2rem; font-size: 4rem; color: var(--secundario); cursor: pointer; font-family: var(--fuentePrincipal); line-height: 0.8; }
        .modal-close:hover { color: var(--primario); }

        .form-modal label { display: block; font-family: var(--fuentePrincipal); font-size: 2.2rem; color: var(--blanco); margin-bottom: 0.5rem; }
        .form-modal input, .form-modal select { width: 100%; padding: 1rem; margin-bottom: 2rem; font-size: 1.6rem; border-radius: 0.5rem; border: none; }

        /* Mi Cuenta */
        #vista-mi-cuenta { display: none; }
        .venta-item { background-color: var(--secundarioscuro); padding: 2rem; margin-bottom: 2rem; border-radius: 1rem; border-left: 5px solid var(--primario); }
        .venta-header { display: flex; justify-content: space-between; font-family: var(--fuentePrincipal); font-size: 2.4rem; color: var(--secundarioscurotext); cursor: pointer; }

        .tabla-pagos { width: 100%; border-collapse: collapse; margin-top: 1.5rem; background-color: var(--blanco); color: var(--negro); }
        .tabla-pagos th { background-color: var(--primarioocuro); color: var(--blanco); padding: 1rem; font-family: var(--fuentePrincipal); font-size: 1.8rem; }
        .tabla-pagos td { padding: 1rem; border-bottom: 1px solid #ccc; text-align: center; font-size: 1.6rem; }

        .mensaje-info { color: var(--blanco); font-size: 2.4rem; text-align: center; font-family: var(--fuentePrincipal); margin-top: 5rem; }
        .mensaje-error { color: #ff6b6b; font-size: 2rem; text-align: center; font-family: 'Nunito', sans-serif; }

        /* Ajuste Nav */
        .navegacion__enlace { cursor: pointer; }
    </style>
</head>
<body>
<header class="header">
    <a href="/index.html">
        <img class="header__logo" src="/img/logo_agencia.png" alt="Logotipo">
    </a>
</header>

<nav class="navegacion" id="nav-principal">
</nav>

<main class="contenedor">
    <div id="vista-catalogo">
        <h1>Catálogo de Vehículos</h1>
        <div class="filtros-bar">
            <div class="filtro-grupo">
                <label>Modelo:</label>
                <input type="text" id="filtro-texto" placeholder="Ej: Civic..." onkeyup="aplicarFiltros()">
            </div>
            <div class="filtro-grupo">
                <label>Precio Máx:</label>
                <input type="range" id="filtro-precio" min="50000" max="2000000" step="10000" value="2000000" oninput="aplicarFiltros()">
                <span id="label-precio-max" style="color: var(--secundarioscurotext); font-family: var(--fuentePrincipal); font-size: 2rem;">$2,000,000</span>
            </div>
            <div class="filtro-grupo">
                <label>Estado:</label>
                <select id="filtro-estado" onchange="aplicarFiltros()">
                    <option value="todos">Todos</option>
                    <option value="nuevo">Nuevo</option>
                    <option value="usado">Usado</option>
                </select>
            </div>
        </div>
        <div class="grid" id="catalogo-container">
            <p class="mensaje-info">Cargando inventario...</p>
        </div>
    </div>

    <div id="vista-mi-cuenta">
        <h1>Mi Estado de Cuenta</h1>
        <div id="cuenta-container"></div>
    </div>
</main>

<footer class="footer">
    <p class="footer__texto">Titan Autos - Todos los derechos reservados 2025.</p>
</footer>

<div id="modal-login" class="modal-overlay" onclick="cerrarModales(event)">
    <div class="modal-contenido" style="max-width: 400px;">
        <span class="modal-close" onclick="cerrarModales()">&times;</span>
        <h2 style="text-align: center; font-family: var(--fuentePrincipal); font-size: 3rem; margin-bottom: 2rem;">Iniciar Sesión</h2>
        <div id="login-error" class="mensaje-error"></div>
        <div class="form-modal">
            <label>Usuario:</label>
            <input type="text" id="txt-usuario">
            <label>Contraseña:</label>
            <input type="password" id="txt-password">
            <button class="formulario__submit" onclick="intentarLogin()" style="width:100%;">Ingresar</button>
        </div>
    </div>
</div>

<div id="modal-detalle" class="modal-overlay" onclick="cerrarModales(event)">
    <div class="modal-contenido">
        <span class="modal-close" onclick="cerrarModales()">&times;</span>
        <div id="detalle-contenido" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;"></div>
    </div>
</div>

<div id="modal-cotizacion" class="modal-overlay" onclick="cerrarModales(event)">
    <div class="modal-contenido" style="max-width: 500px;">
        <span class="modal-close" onclick="cerrarModales()">&times;</span>
        <h2 style="text-align: center; font-family: var(--fuentePrincipal); font-size: 3rem;">Simular Crédito</h2>
        <div class="form-modal">
            <label>Vehículo: <span id="cot-nombre" style="color: var(--primario);"></span></label>
            <label>Precio:</label>
            <input type="text" id="cot-precio" readonly style="background-color: #ccc; color: #333;">
            <label>Enganche (Mín 20%):</label>
            <input type="number" id="cot-enganche">
            <label>Plazo:</label>
            <select id="cot-plazo">
                <option value="12">12 Meses</option>
                <option value="24">24 Meses</option>
                <option value="36">36 Meses</option>
                <option value="48">48 Meses</option>
            </select>
            <button class="formulario__submit" onclick="calcularCotizacion()" style="width:100%;">Calcular</button>
            <div id="resultado-cotizacion" style="margin-top: 2rem; display: none; text-align: center; background: var(--secundarioscuro); padding: 1rem; border-radius: 1rem;">
                <p style="margin:0;">Mensualidad:</p>
                <p id="pago-mensual" style="font-size: 4rem; color: var(--secundarioscurotext); font-family: var(--fuentePrincipal); margin: 0;"></p>
                <p id="detalle-cotizacion" style="font-size: 1.4rem; color: var(--blanco); margin-top: 0.5rem;"></p>
            </div>
        </div>
    </div>
</div>

<script>
    let vehiculosCompletos = [];
    let precioBaseActual = 0;

    document.addEventListener("DOMContentLoaded", () => {
        actualizarMenu();
        cargarVehiculos();
        // Revisar si venimos de "Iniciar Sesión" en otra página
        if(localStorage.getItem('abrirLogin') === 'true') {
            abrirModal('modal-login');
            localStorage.removeItem('abrirLogin');
        }
        // Revisar si venimos a "Mi Cuenta"
        if(window.location.hash === '#micuenta') {
            mostrarMiCuenta();
        }
    });

    function actualizarMenu() {
        const nav = document.getElementById('nav-principal');
        const cliente = JSON.parse(localStorage.getItem('cliente'));
        let html = `
            <a class="navegacion__enlace" href="#" onclick="mostrarVistaCatalogo()" style="color:var(--secundario);">Catálogo</a>
            <a class="navegacion__enlace" href="servicios.html">Servicios</a>
        `;
        if (cliente) {
            html += `<a class="navegacion__enlace" href="#" onclick="mostrarMiCuenta()">Mi Cuenta (${cliente.nombre})</a>
                     <a class="navegacion__enlace" href="#" onclick="cerrarSesion()">Salir</a>`;
        } else {
            html += `<a class="navegacion__enlace" href="#" onclick="abrirModal('modal-login')">Iniciar Sesión</a>`;
        }
        nav.innerHTML = html;
    }

    function mostrarVistaCatalogo() {
        document.getElementById('vista-catalogo').style.display = 'block';
        document.getElementById('vista-mi-cuenta').style.display = 'none';
    }

    async function mostrarMiCuenta() {
        const cliente = JSON.parse(localStorage.getItem('cliente'));
        if(!cliente) { abrirModal('modal-login'); return; }

        document.getElementById('vista-catalogo').style.display = 'none';
        document.getElementById('vista-mi-cuenta').style.display = 'block';
        const container = document.getElementById('cuenta-container');

        try {
            const res = await fetch(`/api/clientes/${cliente.idCliente}/ventas-financiadas`);
            const ventas = await res.json();
            if(ventas.length === 0) {
                container.innerHTML = '<p class="mensaje-info">No tienes financiamientos activos.</p>';
                return;
            }
            let html = '';
            for(const v of ventas) {
                html += `
                <div class="venta-item">
                    <div class="venta-header" onclick="togglePagos(${v.idVenta})">
                         <span>${v.nombreVehiculo}</span>
                         <span>Deuda: $${v.precioFinal.toLocaleString()} ▼</span>
                    </div>
                    <div id="pagos-${v.idVenta}" style="display:none;"><p style="font-size:1.6rem;">Cargando...</p></div>
                </div>`;
            }
            container.innerHTML = html;
        } catch(e) { console.error(e); }
    }

    async function togglePagos(id) {
        const div = document.getElementById(`pagos-${id}`);
        if(div.style.display === 'block') { div.style.display = 'none'; return; }
        div.style.display = 'block';
        const res = await fetch(`/api/clientes/ventas/${id}/pagos`);
        const pagos = await res.json();
        let tabla = `<table class="tabla-pagos"><tr><th>#</th><th>Monto</th><th>Vence</th><th>Estado</th></tr>`;
        pagos.forEach(p => {
            const color = p.estado === 'PAGADO' ? '#2ecc71' : '#e67e22';
            tabla += `<tr><td>${p.numeroPago}</td><td>$${p.monto.toLocaleString()}</td><td>${p.fechaVencimiento || '-'}</td><td style="color:${color}; font-weight:bold;">${p.estado}</td></tr>`;
        });
        tabla += `</table>`;
        div.innerHTML = tabla;
    }

    async function cargarVehiculos() {
        try {
            const res = await fetch('/api/vehiculos/catalogo');
            vehiculosCompletos = await res.json();
            renderizar(vehiculosCompletos);
        } catch(e) {
            document.getElementById('catalogo-container').innerHTML = '<p class="mensaje-error">Error de conexión con la API</p>';
        }
    }

    function aplicarFiltros() {
        const txt = document.getElementById('filtro-texto').value.toLowerCase();
        const max = document.getElementById('filtro-precio').value;
        const est = document.getElementById('filtro-estado').value;
        document.getElementById('label-precio-max').innerText = `$${parseInt(max).toLocaleString()}`;
        const filtrados = vehiculosCompletos.filter(v => {
            const nombre = (v.nombreMarca + " " + v.nombreModelo).toLowerCase();
            return nombre.includes(txt) && v.precio <= max && (est === 'todos' || v.estado.toLowerCase() === est);
        });
        renderizar(filtrados);
    }

    function renderizar(lista) {
        const container = document.getElementById('catalogo-container');
        if (lista.length === 0) { container.innerHTML = '<p class="mensaje-info">No se encontraron vehículos.</p>'; return; }
        let html = '';
        lista.forEach(v => {
            const img = v.imagenPath ? `/img/autos_nuevos/${v.imagenPath}` : '/img/no_image.png';
            html += `
            <div class="producto">
                <span class="etiqueta-estado">${v.estado.toUpperCase()}</span>
                <div onclick="abrirDetalle(${v.idVehiculo})">
                    <img class="producto__imagen" src="${img}" style="height: 200px; object-fit: cover;" onerror="this.src='/img/no_image.png'">
                    <div class="producto__informacion">
                        <p class="producto__nombre">${v.nombreMarca} ${v.nombreModelo}</p>
                        <p class="producto__precio">$${v.precio.toLocaleString()}</p>
                        <p style="text-align:center; font-size:1.4rem; color:var(--blanco); margin-bottom:1rem;">${v.anio} • ${v.kilometraje.toLocaleString()} km</p>
                    </div>
                </div>
                <button class="boton-card" onclick="abrirCotizador(${v.precio}, '${v.nombreMarca} ${v.nombreModelo}')">Cotizar</button>
            </div>`;
        });
        container.innerHTML = html;
    }

    async function abrirDetalle(id) {
        abrirModal('modal-detalle');
        document.getElementById('detalle-contenido').innerHTML = '<p class="mensaje-info">Cargando...</p>';
        const res = await fetch(`/api/vehiculos/${id}`);
        const v = await res.json();
        const img = v.imagenPath ? `/img/autos_nuevos/${v.imagenPath}` : '/img/no_image.png';
        document.getElementById('detalle-contenido').innerHTML = `
            <div><img src="${img}" style="width:100%; border-radius: 1rem; border: 2px solid var(--primario);"></div>
            <div>
                <h2 style="font-size: 4rem; font-family: var(--fuentePrincipal); color: var(--primario);">${v.nombreMarca} ${v.nombreModelo}</h2>
                <p class="producto__precio" style="text-align:left;">$${v.precio.toLocaleString()}</p>
                <div style="margin-top: 2rem; font-size: 1.8rem;">
                    <p><strong>Año:</strong> ${v.anio}</p>
                    <p><strong>Color:</strong> ${v.color}</p>
                    <p><strong>Kilometraje:</strong> ${v.kilometraje.toLocaleString()} km</p>
                    <p><strong>VIN:</strong> ${v.numeroSerie}</p>
                </div>
                <button class="formulario__submit" style="margin-top:2rem; width:100%;" onclick="cerrarModales(); abrirCotizador(${v.precio}, '${v.nombreMarca} ${v.nombreModelo}')">Simular Financiamiento</button>
            </div>`;
    }

    function abrirCotizador(precio, nombre) {
        event.stopPropagation();
        precioBaseActual = precio;
        document.getElementById('cot-nombre').innerText = nombre;
        document.getElementById('cot-precio').value = `$${precio.toLocaleString()}`;
        const min = precio * 0.2;
        document.getElementById('cot-enganche').min = min;
        document.getElementById('cot-enganche').value = min;
        document.getElementById('resultado-cotizacion').style.display = 'none';
        abrirModal('modal-cotizacion');
    }

    async function calcularCotizacion() {
        const eng = document.getElementById('cot-enganche').value;
        const plazo = document.getElementById('cot-plazo').value;
        if(eng < precioBaseActual * 0.2) { alert("El enganche debe ser al menos 20%"); return; }
        const res = await fetch(`/api/cotizar/simular?precio=${precioBaseActual}&enganche=${eng}&plazo=${plazo}`);
        const data = await res.json();
        document.getElementById('pago-mensual').innerText = `$${data.pagoMensual.toLocaleString()}`;
        document.getElementById('detalle-cotizacion').innerText = `Financiamiento: $${data.montoFinanciado.toLocaleString()}`;
        document.getElementById('resultado-cotizacion').style.display = 'block';
    }

    async function intentarLogin() {
        const u = document.getElementById('txt-usuario').value;
        const p = document.getElementById('txt-password').value;
        try {
            const res = await fetch('/api/clientes/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({usuario: u, password: p})
            });
            if (res.ok) {
                const cliente = await res.json();
                localStorage.setItem('cliente', JSON.stringify(cliente));
                cerrarModales();
                actualizarMenu();
                mostrarMiCuenta();
            } else {
                document.getElementById('login-error').innerText = "Datos incorrectos";
            }
        } catch(e) { console.error(e); }
    }

    function cerrarSesion() { localStorage.removeItem('cliente'); actualizarMenu(); mostrarVistaCatalogo(); }
    function abrirModal(id) { document.getElementById(id).style.display = 'flex'; }
    function cerrarModales(e) { if (!e || e.target.classList.contains('modal-overlay') || e.target.classList.contains('modal-close')) document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); }
</script>
</body>
</html>